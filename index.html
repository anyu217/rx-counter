
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>藥錠辨識計數器 V3.9</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script async src="https://docs.opencv.org/4.5.5/opencv.js" onload="onOpenCvReady()"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 1em; }
    video, canvas { display: block; margin: 0.5em auto; }
    #overlay { font-size: 1.2em; margin-top: 0.5em; color: #0a0; }
  </style>
</head>
<body>
  <h2>藥錠即時辨識計數器 V3.9</h2>
  <div>
    <label for="resolution">解析度：</label>
    <select id="resolution">
      <option value="640x480" selected>640x480</option>
      <option value="1280x720">1280x720</option>
      <option value="1920x1080">1920x1080</option>
    </select>
    <button id="start">📷 開啟後鏡頭</button>
  </div>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="overlay">尚未啟動相機</div>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let overlay = document.getElementById('overlay');
    let ctx = canvas.getContext('2d');
    let stream = null;
    let opencvReady = false;

    function drawDot(x, y) {
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, 2 * Math.PI);
      ctx.fillStyle = "#00FF00";
      ctx.fill();
    }

    function processFrame() {
      if (!opencvReady || video.videoWidth === 0) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);
      let binary = new cv.Mat();
      cv.threshold(gray, binary, 200, 255, cv.THRESH_BINARY);

      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();
      cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      let count = 0;
      for (let i = 0; i < contours.size(); ++i) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        if (area < 100 || area > 3000) continue;
        let peri = cv.arcLength(cnt, true);
        let circularity = 4 * Math.PI * area / (peri * peri);
        if (circularity < 0.4) continue;
        let M = cv.moments(cnt);
        let cx = M.m10 / M.m00;
        let cy = M.m01 / M.m00;
        drawDot(cx, cy);
        count++;
      }

      overlay.textContent = `偵測數量：${count} ｜ 解析度：${video.videoWidth}x${video.videoHeight}`;
      src.delete(); gray.delete(); binary.delete(); contours.delete(); hierarchy.delete();
    }

    function onOpenCvReady() {
      opencvReady = true;
      setInterval(processFrame, 1000);
    }

    document.getElementById('start').onclick = async () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      const resolution = document.getElementById('resolution').value;
      const [w, h] = resolution.split('x').map(Number);

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: w },
            height: { ideal: h }
          }
        });
        video.srcObject = stream;
      } catch (e) {
        overlay.textContent = "相機啟動失敗：" + e.message;
      }
    };
  </script>
</body>
</html>
